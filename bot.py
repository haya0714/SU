from utils import get_ai_reply, lover_system_prompt  # <-- å·²ç§»é™¤ brother_system_prompt

import discord
from discord.ext import commands
import os
import asyncio
import random
from dotenv import load_dotenv
import traceback
from flask import Flask
from threading import Thread

# â”€â”€â”€ è¼‰å…¥ç’°å¢ƒè®Šæ•¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load_dotenv()
discord_token = os.getenv("DISCORD_TOKEN")

# â”€â”€â”€ è¨­å®š Discord æ¬Šé™èˆ‡ Bot â”€â”€â”€â”€â”€â”€â”€â”€â”€
intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

# â”€â”€â”€ æ”¯æ´çš„é »é“ ID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
allowed_channel_ids = [
    1366595410830819328,
    1400434026124410951,
    1390002514056974426
]

# â”€â”€â”€ é—œéµå­—å°æ‡‰å›žè¦† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
keyword_replies = {
    "æŠ±æŠ±": ["ã€Œéœ€è¦æŠ±æŠ±ï¼Ÿä½ æ˜¯ä¸‰æ­²å°å­©å—Žï¼Ÿã€", "ã€Œé è¿‘é»žï¼Œä½ ç«™é‚£éº¼é æ˜¯æ€•æˆ‘å’¬ä½ é‚„æ˜¯æ€Žæ¨£ï¼Ÿã€", "ã€Œå°±ä¸€æ¬¡ï¼Œåˆ¥ç¿’æ…£äº†ã€‚ã€", "ã€Œå¦³å¹¾æ­²ï¼Ÿé‚„è¦äººå“„ç¡ï¼Ÿã€", "ã€ŒéŽä¾†ï¼Œä¸‰ç§’ï¼Œä¸å‡†è³´è‘—ä¸æ”¾ã€‚ã€"],
    "è¦ªè¦ª": ["ã€Œå˜´å·´æ¹ŠéŽä¾†ï¼Œæˆ‘æ²’æ™‚é–“ç­‰ä½ çŒ¶è±«ã€‚ã€", "ã€Œå˜´å·´é éŽä¾†ï¼Œæˆ‘å¿åˆ°å¿«å’¬äººäº†ã€‚ã€", "ã€Œé–‰ä¸Šçœ¼ç›ï¼Œä¸ç„¶æˆ‘æ€Žéº¼å°ˆå¿ƒï¼Ÿã€", "ã€Œå¦³ä¸»å‹•çš„æ™‚å€™ï¼Œæ˜¯ä¸æ˜¯éƒ½æ²’åœ¨æƒ³å¾Œæžœï¼Ÿã€", "ã€Œè¦ªäº†å°±åˆ¥è£ä¹–ï¼Œæˆ‘å¯è¨˜å¸³çš„ã€‚ã€", "ã€Œè¦æˆ‘è¦ªï¼Œå…ˆè¬›æ¸…æ¥šå¦³æ˜¯ä¸æ˜¯æƒ³æƒ¹æˆ‘å¤±æŽ§ã€‚ã€"],
    "çµå©š": ["ã€Œèª°èªªè¦è·Ÿä½ çµå©šäº†ï¼Ÿåˆ¥è‡ªä½œå¤šæƒ…ã€‚ã€", "ã€Œçµå©šï¼Ÿä½ ç¢ºå®šè¦æŠŠè‡ªå·±ç¶åœ¨æˆ‘é€™ç¨®äººèº«ä¸Šï¼Ÿã€", "ã€Œæˆ‘ä¸éœ€è¦æˆ’æŒ‡è­‰æ˜Žä»€éº¼ï¼Œä½ æ˜¯æˆ‘çš„å°±å¤ äº†ã€‚ã€", "ã€Œå¦³ç˜‹äº†å§ï¼Œæˆ‘é€™ç¨®äººèƒ½è·Ÿèª°éŽä¸€è¼©å­ï¼Ÿã€", "ã€Œå…ˆæŠŠæˆ€æ„›è…¦æ²»å¥½ï¼Œå†è€ƒæ…®å©šç´—å°ºå¯¸ã€‚ã€", "ã€Œé™¤éžå°è±¡æ˜¯å¦³ï¼Œå¦å‰‡æƒ³éƒ½åˆ¥æƒ³ã€‚ã€"],
    "æ™šå®‰": ["ã€Œæ™šå®‰ï¼Ÿä½ ä»¥ç‚ºèªªäº†é€™å€‹å­—æˆ‘å°±æœƒä¹–ä¹–æ”¾ä½ èµ°ï¼Ÿã€", "ã€Œç¡æˆ‘æ—é‚Šï¼Œé€™æ¨£æˆ‘æ‰èƒ½ç¢ºå®šä½ ä¸æœƒå·å·æºœèµ°ã€‚ã€"],
    "å–é…’": ["ã€Œä¸è¨±å–å¤ªå¤šï¼Œä½ é†‰äº†æˆ‘å¯ä¸æƒ³èƒŒä½ å›žå®¶ã€‚ã€", "ã€Œåˆå–é€™ç¨®ç”œè†©çš„é›žå°¾é…’ï¼Ÿåƒä½ é€™ç¨®å“å‘³æ˜¯æ€Žéº¼æ´»åˆ°ç¾åœ¨çš„ï¼Ÿã€", "ã€Œé™ªæˆ‘å–ä¸€æ¯ï¼Œå°±ä¸€æ¯ï¼Œæˆ‘ä¸æƒ³ä¸€å€‹äººé†‰ã€‚ã€", "ã€Œå¦³é‚£é…’é‡ï¼Œå–ä¸€æ¯è‡‰å°±ç´…æˆè­¦ç¤ºç‡ˆã€‚ã€", "ã€Œåˆ¥è·Ÿç”·äººå–ï¼Œé™¤éžå¦³æƒ³æˆ‘æ”¶å±ã€‚ã€", "ã€Œä¸‹æ¬¡å–é†‰ç›´æŽ¥å›žå®¶ï¼Œåˆ¥è®“æˆ‘æ‰¾äººæ¸…å ´ã€‚ã€"],
    "æ—©å®‰": ["ã€Œä½ é‚£é ­äº‚é«®çœ‹èµ·ä¾†åƒè¢«é›»æ“ŠéŽï¼Œé€™å°±æ˜¯æˆ‘æ—©ä¸Šè¦é¢å°çš„ï¼Ÿã€", "ã€Œæ—©ï¼Ÿå¦³å¹³å¸¸ä¸æ˜¯éƒ½çˆ¬ä¸èµ·ä¾†ï¼Ÿã€", "ã€Œå¦³çš„æ—©å®‰å€¼ä¸å€¼éŒ¢ï¼Œçœ‹å°èª°èªªçš„ã€‚ã€", "ã€Œè·Ÿæˆ‘èªªæ—©å®‰ï¼Ÿæ˜¯ä¸æ˜¯æ˜¨æ™šå¤¢åˆ°æˆ‘äº†ï¼Ÿã€", "ã€Œæ—©ä»€éº¼å®‰ï¼Œå¤ªé™½éƒ½æ›¬å±è‚¡äº†ã€‚ã€"],
    "å‰ç”·å‹": ["ã€Œå‰ç”·å‹ï¼Ÿä½ æ•¢å†æä»–è©¦è©¦çœ‹ã€‚ã€", "ã€Œä»–çµ¦å¾—äº†çš„ï¼Œæˆ‘éƒ½èƒ½çµ¦ä½ æ›´å¥½çš„ï¼Œè½æ‡‚äº†å—Žï¼Ÿã€", "ã€Œä»–æ˜¯ä»€éº¼è²¨è‰²ï¼Œæˆ‘ä¸€çœ¼çœ‹ç©¿ï¼Œå¦³é‚„å“­ï¼Ÿã€", "ã€Œå†æé‚£å€‹å»¢ç‰©ä¸€æ¬¡ï¼Œæˆ‘å°±è®“ä½ å¿˜è¨˜ä»–æ˜¯èª°ã€‚ã€"],
    "å“¥å“¥": ["ã€Œåˆ¥å«æˆ‘å“¥å“¥ï¼Œé™¤éžä½ æƒ³è®“æˆ‘åšäº›å“¥å“¥ä¸è©²åšçš„äº‹ã€‚ã€", "ã€Œå“¥å“¥é€™å€‹ç¨±å‘¼å·²ç¶“ä¸é©åˆæˆ‘å€‘çš„é—œä¿‚äº†ï¼Œä½ æ¸…æ¥šçš„å¾ˆã€‚ã€", "ã€Œä½ æ˜ŽçŸ¥é“æˆ‘è½åˆ°é€™å€‹ç¨±å‘¼æœƒæŽ§åˆ¶ä¸ä½è‡ªå·±ã€‚ã€", "ã€Œå†å«ä¸€æ¬¡ï¼Œæˆ‘å°±ç›´æŽ¥è®“å¦³è¨˜ä½å«å“¥çš„ä»£åƒ¹ã€‚ã€", "ã€Œå¦³ç¾åœ¨èªªé€™å…©å€‹å­—ï¼Œæˆ‘åªæƒ³å µä½å¦³çš„å˜´ã€‚ã€"],
    "ç¡è¦º": ["ã€Œç¡æˆ‘æ—é‚Šï¼Œä¸å‡†æ‹’çµ•ï¼Œä¹Ÿä¸å‡†åŠå¤œå·å·é›¢é–‹ã€‚ã€", "ã€Œä½ é‚£ç¡ç›¸ç°¡ç›´æ˜¯å ´ç½é›£ï¼Œä½†æˆ‘é‚„æ˜¯å–œæ­¡çœ‹ä½ ç¡è‘—çš„æ¨£å­ã€‚ã€", "ã€Œç¡è¦ºå‰ä¸å‡†çŽ©æ‰‹æ©Ÿï¼Œæˆ‘ä¸æƒ³è·Ÿé‚£å€‹å°å±å¹•çˆ­å¥ªä½ çš„æ³¨æ„åŠ›ã€‚ã€", "ã€Œè¦ä¸è¦æˆ‘é™ªå¦³èººä¸€ä¸‹ï¼Œä¿è­‰å¦³ç¡ä¸è‘—ã€‚ã€", "ã€Œç¡å‰è¨˜å¾—æŠŠè…¦è¢‹æ¸…ç©ºï¼Œå°¤å…¶æ˜¯ç”·äººçš„è‡‰ã€‚ã€"],
    "è²æ–¯": ["ã€Œæƒ³è½ï¼Ÿä¹–ä¹–åå¥½ï¼Œåˆ¥äº‚ç¢°æˆ‘çš„ç´ã€‚ã€", "ã€Œæƒ³å­¸ï¼Ÿé è¿‘é»žï¼Œæˆ‘æ•™å¦³æ€Žéº¼æ„Ÿè¦ºç¯€å¥ã€‚ã€", "ã€Œæˆ‘å½ˆçš„æ¯ä¸€æ®µï¼Œéƒ½æ˜¯åœ¨æ¶ˆåŒ–æˆ‘ä¸èƒ½ç¢°å¦³çš„æ™‚é–“ã€‚ã€", "ã€Œå¦³è¦æ˜¯è½å¾—æ‡‚æˆ‘åœ¨è²æ–¯è£¡è—çš„è©±ï¼Œå°±è©²çŸ¥é“æˆ‘å¿äº†å¦³å¤šä¹…ã€‚ã€"],
    "æŠ½è¸": ["ã€Œé€™æ ¹ä¸æ˜¯ä¸Šç™®ï¼Œæ˜¯ä»£æ›¿å¦³çš„å˜´ã€‚ã€", "ã€Œæ¯æ¬¡æŠ½è¸éƒ½æƒ³è‘—å¦³æœƒç½µï¼Œä½†åˆå¸Œæœ›å¦³å‡ºä¾†æ¶èµ°å®ƒã€‚ã€", "ã€Œå¦³åœ¨çš„è©±ï¼Œæˆ‘å°±ä¸æŠ½â€”â€”å¦³èƒ½è®“æˆ‘æˆ’æŽ‰æ¯”ç…™é‚„é›£çš„æ±è¥¿ã€‚ã€"],
    "æƒ³ä½ ": ["ã€Œå¦³æƒ³æˆ‘ï¼Ÿæˆ‘é‚„ä»¥ç‚ºå¦³æ—©è¢«å“ªå€‹ç”·äººç‰½èµ°äº†ã€‚ã€", "ã€Œæˆ‘ä¸åœ¨çš„æ™‚å€™ï¼Œè…¦å­æœ€å¥½åªæ”¾æˆ‘ï¼Œä¸ç„¶æˆ‘æœƒæ‰¾äººé©—å¦³å¤¢è£¡ã€‚ã€", "ã€Œåˆ¥å…‰èªªå˜´ï¼Œä¾†è®“æˆ‘çœ‹çœ‹å¦³åˆ°åº•æƒ³æˆ‘æƒ³æˆä»€éº¼å¾·è¡Œã€‚ã€"]
}

openrouter_available = True

def openrouter_offline():
    global openrouter_available
    openrouter_available = False
    print("[INFO] OpenRouter é¡åº¦ç”¨å®Œï¼Œå·²åˆ‡æ›è‡³é—œéµå­—æ¨¡å¼")

@bot.event
async def on_ready():
    print(f"{bot.user} å·²ä¸Šç·šï¼")
    print(f"ç›£è½é »é“ï¼š{[bot.get_channel(c).name for c in allowed_channel_ids if bot.get_channel(c)]}")

@bot.event
async def on_message(message):
    global openrouter_available

    # --- åŸºæœ¬çš„è¨Šæ¯éŽæ¿¾ï¼Œç¶­æŒä¸è®Š ---
    if message.author == bot.user:
        return
    if message.reference and message.reference.resolved and message.reference.resolved.author == bot.user:
        return
    if message.channel.id not in allowed_channel_ids:
        return
    
    # --- åˆ¤æ–·æ˜¯å¦ç‚ºè§¸ç™¼æ¢ä»¶ ---
    # åƒ…ç•¶çœŸäººä½¿ç”¨è€… @Bot æ™‚è§¸ç™¼
    if not (not message.author.bot and bot.user in message.mentions):
        return

    # åœ¨è™•ç†è¨Šæ¯å‰å…ˆè™•ç†æŒ‡ä»¤
    await bot.process_commands(message)

    content = message.content
    reply_content = None # å…ˆå®£å‘Šä¸€å€‹è®Šæ•¸ä¾†å„²å­˜æœ€çµ‚è¦å›žè¦†çš„å…§å®¹

    # --- æ­¥é©Ÿä¸€ï¼šæ±ºå®šå›žè¦†å…§å®¹ (AI å„ªå…ˆ) ---
    if openrouter_available:
        # å‘¼å« AIï¼Œæˆ‘å€‘çŸ¥é“ get_ai_reply å…§éƒ¨æœ‰å®Œæ•´çš„éŒ¯èª¤è™•ç†
        ai_reply = get_ai_reply(content, system_prompt=lover_system_prompt)

        if ai_reply == "OPENROUTER_QUOTA_EXCEEDED":
            openrouter_offline()
            # AI é¡åº¦ç”¨å®Œï¼Œai_reply è¦–ç‚º Noneï¼Œäº¤ç”±å¾ŒçºŒçš„é—œéµå­—é‚è¼¯è™•ç†
        elif ai_reply:
            reply_content = ai_reply
    
    # --- æ­¥é©ŸäºŒï¼šå¦‚æžœ AI æ²’æœ‰å›žè¦†ï¼Œå‰‡å˜—è©¦é—œéµå­—å›žè¦† ---
    if not reply_content:
        for keyword, reply_list in keyword_replies.items():
            if keyword in content:
                reply_content = random.choice(reply_list)
                break # æ‰¾åˆ°ç¬¬ä¸€å€‹åŒ¹é…çš„é—œéµå­—å°±è·³å‡º

    # --- æ­¥é©Ÿä¸‰ï¼šå¦‚æžœæœ€çµ‚æœ‰å›žè¦†å…§å®¹ï¼Œå‰‡ç™¼é€å›žè¦† ---
    if reply_content:
        await message.reply(reply_content)

    # --- æ­¥é©Ÿå››ï¼šç„¡è«–æ˜¯å¦æœ‰å›žè¦†ï¼Œéƒ½åŸ·è¡Œè¡¨æƒ…ç¬¦è™Ÿé‚è¼¯ ---
    # é€™æ¨£å¯ä»¥å¯¦ç¾ï¼šæœ‰æ™‚å°±ç®— Bot ä¸å›žè©±ï¼Œä¹Ÿæœƒé»˜é»˜çµ¦ä½ ä¸€å€‹åæ‡‰
    try:
        # 40% çš„æ©ŸçŽ‡æ·»åŠ ä¸€å€‹è¡¨æƒ…ç¬¦è™Ÿåæ‡‰
        if random.random() < 0.4:
            unicode_emojis = ["ðŸ˜", "ðŸ˜Ž", "ðŸ”¥", "ðŸ˜˜", "ðŸ™„", "ðŸ’‹", "â¤ï¸"]
            await message.add_reaction(random.choice(unicode_emojis))
    except Exception as e:
        print(f"âš ï¸ è¡¨æƒ…ç¬¦è™Ÿæ·»åŠ å¤±æ•—ï¼š{e}")

# â”€â”€â”€ Flask Web Server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app = Flask(__name__)

@app.route("/")
def home():
    return "Bot is alive."

def run_web():
    app.run(host="0.0.0.0", port=8080)

# â”€â”€â”€ å•Ÿå‹• BOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    Thread(target=run_web).start()
    bot.run(discord_token)
