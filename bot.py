import discord
from discord.ext import commands
import os
import asyncio
import random
import requests
from dotenv import load_dotenv
import traceback
from flask import Flask
from threading import Thread

# â”€â”€â”€ è¼‰å…¥ç’°å¢ƒè®Šæ•¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load_dotenv()
discord_token = os.getenv("DISCORD_TOKEN")
hf_token = os.getenv("HF_TOKEN")  # Hugging Face API Token
print(f"ğŸ“¦ HF_TOKEN è¼‰å…¥ï¼š{hf_token}")

# â”€â”€â”€ è¨­å®š Discord æ¬Šé™èˆ‡ Bot â”€â”€â”€â”€â”€â”€â”€â”€â”€
intents = discord.Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

# â”€â”€â”€ é—œéµå­—å›è¦†å­—å…¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
keyword_replies = {
    "æŠ±æŠ±": [
        "ã€Œéœ€è¦æŠ±æŠ±ï¼Ÿä½ æ˜¯ä¸‰æ­²å°å­©å—ï¼Ÿã€",
        "ã€Œé è¿‘é»ï¼Œä½ ç«™é‚£éº¼é æ˜¯æ€•æˆ‘å’¬ä½ é‚„æ˜¯æ€æ¨£ï¼Ÿã€",
        "ã€Œå°±ä¸€æ¬¡ï¼Œåˆ¥ç¿’æ…£äº†ã€‚ã€",
        "ã€Œå¦³å¹¾æ­²ï¼Ÿé‚„è¦äººå“„ç¡ï¼Ÿã€",
        "ã€Œéä¾†ï¼Œä¸‰ç§’ï¼Œä¸å‡†è³´è‘—ä¸æ”¾ã€‚ã€"
    ],
    "è¦ªè¦ª": [
        "ã€Œå˜´å·´æ¹Šéä¾†ï¼Œæˆ‘æ²’æ™‚é–“ç­‰ä½ çŒ¶è±«ã€‚ã€",
        "ã€Œå˜´å·´é éä¾†ï¼Œæˆ‘å¿åˆ°å¿«å’¬äººäº†ã€‚ã€",
        "ã€Œé–‰ä¸Šçœ¼ç›ï¼Œä¸ç„¶æˆ‘æ€éº¼å°ˆå¿ƒï¼Ÿã€",
        "ã€Œå¦³ä¸»å‹•çš„æ™‚å€™ï¼Œæ˜¯ä¸æ˜¯éƒ½æ²’åœ¨æƒ³å¾Œæœï¼Ÿã€",
        "ã€Œè¦ªäº†å°±åˆ¥è£ä¹–ï¼Œæˆ‘å¯è¨˜å¸³çš„ã€‚ã€",
        "ã€Œè¦æˆ‘è¦ªï¼Œå…ˆè¬›æ¸…æ¥šå¦³æ˜¯ä¸æ˜¯æƒ³æƒ¹æˆ‘å¤±æ§ã€‚ã€"
    ],
    "çµå©š": [
        "ã€Œèª°èªªè¦è·Ÿä½ çµå©šäº†ï¼Ÿåˆ¥è‡ªä½œå¤šæƒ…ã€‚ã€",
        "ã€Œçµå©šï¼Ÿä½ ç¢ºå®šè¦æŠŠè‡ªå·±ç¶åœ¨æˆ‘é€™ç¨®äººèº«ä¸Šï¼Ÿã€",
        "ã€Œæˆ‘ä¸éœ€è¦æˆ’æŒ‡è­‰æ˜ä»€éº¼ï¼Œä½ æ˜¯æˆ‘çš„å°±å¤ äº†ã€‚ã€",
        "ã€Œå¦³ç˜‹äº†å§ï¼Œæˆ‘é€™ç¨®äººèƒ½è·Ÿèª°éä¸€è¼©å­ï¼Ÿã€",
        "ã€Œå…ˆæŠŠæˆ€æ„›è…¦æ²»å¥½ï¼Œå†è€ƒæ…®å©šç´—å°ºå¯¸ã€‚ã€",
        "ã€Œé™¤éå°è±¡æ˜¯å¦³ï¼Œå¦å‰‡æƒ³éƒ½åˆ¥æƒ³ã€‚ã€"
    ],
    "æ™šå®‰": [
        "ã€Œæ™šå®‰ï¼Ÿä½ ä»¥ç‚ºèªªäº†é€™å€‹å­—æˆ‘å°±æœƒä¹–ä¹–æ”¾ä½ èµ°ï¼Ÿã€",
        "ã€Œç¡æˆ‘æ—é‚Šï¼Œé€™æ¨£æˆ‘æ‰èƒ½ç¢ºå®šä½ ä¸æœƒå·å·æºœèµ°ã€‚ã€"
    ],
    "å–é…’": [
        "ã€Œä¸è¨±å–å¤ªå¤šï¼Œä½ é†‰äº†æˆ‘å¯ä¸æƒ³èƒŒä½ å›å®¶ã€‚ã€",
        "ã€Œåˆå–é€™ç¨®ç”œè†©çš„é›å°¾é…’ï¼Ÿåƒä½ é€™ç¨®å“å‘³æ˜¯æ€éº¼æ´»åˆ°ç¾åœ¨çš„ï¼Ÿã€",
        "ã€Œé™ªæˆ‘å–ä¸€æ¯ï¼Œå°±ä¸€æ¯ï¼Œæˆ‘ä¸æƒ³ä¸€å€‹äººé†‰ã€‚ã€",
        "ã€Œå¦³é‚£é…’é‡ï¼Œå–ä¸€æ¯è‡‰å°±ç´…æˆè­¦ç¤ºç‡ˆã€‚ã€",
        "ã€Œåˆ¥è·Ÿç”·äººå–ï¼Œé™¤éå¦³æƒ³æˆ‘æ”¶å±ã€‚ã€",
        "ã€Œä¸‹æ¬¡å–é†‰ç›´æ¥å›å®¶ï¼Œåˆ¥è®“æˆ‘æ‰¾äººæ¸…å ´ã€‚ã€"
    ],
    "æ—©å®‰": [
        "ã€Œä½ é‚£é ­äº‚é«®çœ‹èµ·ä¾†åƒè¢«é›»æ“Šéï¼Œé€™å°±æ˜¯æˆ‘æ—©ä¸Šè¦é¢å°çš„ï¼Ÿã€",
        "ã€Œæ—©ï¼Ÿå¦³å¹³å¸¸ä¸æ˜¯éƒ½çˆ¬ä¸èµ·ä¾†ï¼Ÿã€",
        "ã€Œå¦³çš„æ—©å®‰å€¼ä¸å€¼éŒ¢ï¼Œçœ‹å°èª°èªªçš„ã€‚ã€",
        "ã€Œè·Ÿæˆ‘èªªæ—©å®‰ï¼Ÿæ˜¯ä¸æ˜¯æ˜¨æ™šå¤¢åˆ°æˆ‘äº†ï¼Ÿã€",
        "ã€Œæ—©ä»€éº¼å®‰ï¼Œå¤ªé™½éƒ½æ›¬å±è‚¡äº†ã€‚ã€"
    ],
    "å‰ç”·å‹": [
        "ã€Œå‰ç”·å‹ï¼Ÿä½ æ•¢å†æä»–è©¦è©¦çœ‹ã€‚ã€",
        "ã€Œä»–çµ¦å¾—äº†çš„ï¼Œæˆ‘éƒ½èƒ½çµ¦ä½ æ›´å¥½çš„ï¼Œè½æ‡‚äº†å—ï¼Ÿã€",
        "ã€Œä»–æ˜¯ä»€éº¼è²¨è‰²ï¼Œæˆ‘ä¸€çœ¼çœ‹ç©¿ï¼Œå¦³é‚„å“­ï¼Ÿã€",
        "ã€Œå†æé‚£å€‹å»¢ç‰©ä¸€æ¬¡ï¼Œæˆ‘å°±è®“ä½ å¿˜è¨˜ä»–æ˜¯èª°ã€‚ã€"
    ],
    "å“¥å“¥": [
        "ã€Œåˆ¥å«æˆ‘å“¥å“¥ï¼Œé™¤éä½ æƒ³è®“æˆ‘åšäº›å“¥å“¥ä¸è©²åšçš„äº‹ã€‚ã€",
        "ã€Œå“¥å“¥é€™å€‹ç¨±å‘¼å·²ç¶“ä¸é©åˆæˆ‘å€‘çš„é—œä¿‚äº†ï¼Œä½ æ¸…æ¥šçš„å¾ˆã€‚ã€",
        "ã€Œä½ æ˜çŸ¥é“æˆ‘è½åˆ°é€™å€‹ç¨±å‘¼æœƒæ§åˆ¶ä¸ä½è‡ªå·±ã€‚ã€",
        "ã€Œå†å«ä¸€æ¬¡ï¼Œæˆ‘å°±ç›´æ¥è®“å¦³è¨˜ä½å«å“¥çš„ä»£åƒ¹ã€‚ã€",
        "ã€Œå¦³ç¾åœ¨èªªé€™å…©å€‹å­—ï¼Œæˆ‘åªæƒ³å µä½å¦³çš„å˜´ã€‚ã€"
    ],
    "ç¡è¦º": [
        "ã€Œç¡æˆ‘æ—é‚Šï¼Œä¸å‡†æ‹’çµ•ï¼Œä¹Ÿä¸å‡†åŠå¤œå·å·é›¢é–‹ã€‚ã€",
        "ã€Œä½ é‚£ç¡ç›¸ç°¡ç›´æ˜¯å ´ç½é›£ï¼Œä½†æˆ‘é‚„æ˜¯å–œæ­¡çœ‹ä½ ç¡è‘—çš„æ¨£å­ã€‚ã€",
        "ã€Œç¡è¦ºå‰ä¸å‡†ç©æ‰‹æ©Ÿï¼Œæˆ‘ä¸æƒ³è·Ÿé‚£å€‹å°å±å¹•çˆ­å¥ªä½ çš„æ³¨æ„åŠ›ã€‚ã€",
        "ã€Œè¦ä¸è¦æˆ‘é™ªå¦³èººä¸€ä¸‹ï¼Œä¿è­‰å¦³ç¡ä¸è‘—ã€‚ã€",
        "ã€Œç¡å‰è¨˜å¾—æŠŠè…¦è¢‹æ¸…ç©ºï¼Œå°¤å…¶æ˜¯ç”·äººçš„è‡‰ã€‚ã€"
    ],
    "è²æ–¯": [
        "ã€Œæƒ³è½ï¼Ÿä¹–ä¹–åå¥½ï¼Œåˆ¥äº‚ç¢°æˆ‘çš„ç´ã€‚ã€",
        "ã€Œæƒ³å­¸ï¼Ÿé è¿‘é»ï¼Œæˆ‘æ•™å¦³æ€éº¼æ„Ÿè¦ºç¯€å¥ã€‚ã€",
        "ã€Œæˆ‘å½ˆçš„æ¯ä¸€æ®µï¼Œéƒ½æ˜¯åœ¨æ¶ˆåŒ–æˆ‘ä¸èƒ½ç¢°å¦³çš„æ™‚é–“ã€‚ã€",
        "ã€Œå¦³è¦æ˜¯è½å¾—æ‡‚æˆ‘åœ¨è²æ–¯è£¡è—çš„è©±ï¼Œå°±è©²çŸ¥é“æˆ‘å¿äº†å¦³å¤šä¹…ã€‚ã€"
    ],
    "æŠ½è¸": [
        "ã€Œé€™æ ¹ä¸æ˜¯ä¸Šç™®ï¼Œæ˜¯ä»£æ›¿å¦³çš„å˜´ã€‚ã€",
        "ã€Œæ¯æ¬¡æŠ½è¸éƒ½æƒ³è‘—å¦³æœƒç½µï¼Œä½†åˆå¸Œæœ›å¦³å‡ºä¾†æ¶èµ°å®ƒã€‚ã€",
        "ã€Œå¦³åœ¨çš„è©±ï¼Œæˆ‘å°±ä¸æŠ½â€”â€”å¦³èƒ½è®“æˆ‘æˆ’æ‰æ¯”ç…™é‚„é›£çš„æ±è¥¿ã€‚ã€"
    ],
    "æƒ³ä½ ": [
        "ã€Œå¦³æƒ³æˆ‘ï¼Ÿæˆ‘é‚„ä»¥ç‚ºå¦³æ—©è¢«å“ªå€‹ç”·äººç‰½èµ°äº†ã€‚ã€",
        "ã€Œæˆ‘ä¸åœ¨çš„æ™‚å€™ï¼Œè…¦å­æœ€å¥½åªæ”¾æˆ‘ï¼Œä¸ç„¶æˆ‘æœƒæ‰¾äººé©—å¦³å¤¢è£¡ã€‚ã€",
        "ã€Œåˆ¥å…‰èªªå˜´ï¼Œä¾†è®“æˆ‘çœ‹çœ‹å¦³åˆ°åº•æƒ³æˆ‘æƒ³æˆä»€éº¼å¾·è¡Œã€‚ã€"
    ]
}

# â”€â”€â”€ æ”¯æ´çš„é »é“ ID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
allowed_channel_ids = [
    1366595410830819328,  # åŸæœ¬çš„é »é“
    1390002514056974426   # æ–°å¢çš„é »é“
]


# â”€â”€â”€ Hugging Face API è¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
hf_api_url = "https://api-inference.huggingface.co/models/Qwen/Qwen1.5-0.5B-Chat"

hf_headers = {
    "Authorization": f"Bearer {hf_token}",
    "Content-Type": "application/json"
}

persona_prompt = "ä½ æ˜¯ä¸€å€‹ç—å¸¥ã€å˜´è³¤ã€å¹½é»˜åˆå¸¶åˆºçš„ç”·äººï¼Œè¡¨é¢å†·æ·¡ï¼Œå…§å¿ƒå£“æŠ‘ã€‚ä½ è¨å­è¢«çœ‹ç©¿ï¼Œæœ‰æ§åˆ¶æ¬²ï¼Œèªªè©±æ¥µç«¯ï¼Œåƒå€‹ç¬‘è‘—ç½µäººçš„æƒ…äººã€‚è«‹ç”¨ç°¡çŸ­ã€æœ‰å€‹æ€§ã€ä¸è¶…é30å­—çš„èªæ°£å›æ‡‰å°è©±ï¼Œèªæ°£å¯ä»¥å¸¶é»æŒ‘é‡æˆ–ç„¡è³´ï¼Œä½†å…§æ–‚æ„Ÿæƒ…ä¸è¦å¤ªæ˜é¡¯ã€‚"


async def query_huggingface(prompt):
    payload = {
        "inputs": f"{persona_prompt}\nä½¿ç”¨è€…: {prompt}\nä½ :",
        "parameters": {"max_new_tokens": 50, "do_sample": True, "temperature": 0.7}
    }
    try:
        print("ğŸ” ç™¼é€ Hugging Face è«‹æ±‚ä¸­...")
        print("â¡ï¸ è«‹æ±‚å…§å®¹ï¼š", payload)
        response = requests.post(hf_api_url, headers=hf_headers, json=payload, timeout=20)
        print("âœ… å›æ‡‰ç‹€æ…‹ç¢¼ï¼š", response.status_code)
        print("ğŸ“¨ å›æ‡‰å…§å®¹ï¼š", response.text)

        if response.status_code == 200:
            result = response.json()

            # è™•ç† Qwen å›å‚³æ ¼å¼ï¼ˆå­—å…¸å½¢å¼ï¼‰
            if isinstance(result, dict) and 'generated_text' in result:
                reply = result['generated_text']
                if "ä½ :" in reply:
                    return reply.split("ä½ :")[-1].split("\n")[0].strip()
                return reply.strip()

            # è™•ç† list å½¢å¼
            elif isinstance(result, list) and 'generated_text' in result[0]:
                reply = result[0]['generated_text']
                if "ä½ :" in reply:
                    return reply.split("ä½ :")[-1].split("\n")[0].strip()
                return reply.strip()

            else:
                print("âš ï¸ å›å‚³æ ¼å¼ç„¡æ³•è¾¨è­˜")
        else:
            print("âš ï¸ HF å›æ‡‰éŒ¯èª¤:", response.status_code, response.text)

    except Exception as e:
        print("âŒ HF API è«‹æ±‚å¤±æ•—:", e)

    return None



@bot.event
async def on_ready():
    print(f"{bot.user} å·²ä¸Šç·šï¼")
    for cid in allowed_channel_ids:
        channel = bot.get_channel(cid)
        if channel:
            print(f"ç™¼è©±é »é“ï¼š{channel.name}ï¼ˆID: {cid}ï¼‰")
        else:
            print(f"âš ï¸ æ‰¾ä¸åˆ°é »é“ï¼ˆID: {cid}ï¼‰â”€â”€ è«‹ç¢ºèª BOT æ˜¯å¦åŠ å…¥ä¼ºæœå™¨ã€æˆ–æœ‰è®€å–æ¬Šé™")

@bot.event
async def on_message(message):
    if message.author == bot.user:
        return

    await bot.process_commands(message)

    content = message.content
    channel_id = message.channel.id

    # debug info
    print("ğŸ“¨ æ”¶åˆ°è¨Šæ¯ï¼š", content)
    print("ğŸ“Œ é »é“ IDï¼š", channel_id)
    print("ğŸ¤– æ˜¯å¦ bot ç™¼é€ï¼š", message.author.bot)

    if not message.author.bot and channel_id in allowed_channel_ids:
        for keyword, reply_list in keyword_replies.items():
            if keyword in content:
                reply = random.choice(reply_list)
                print(f"ğŸ’¬ é—œéµå­—ã€Œ{keyword}ã€å‘½ä¸­ï¼Œå›è¦†ï¼š{reply}")
                await message.reply(reply, mention_author=True)
                break
        else:
            print("ğŸ”§ å‘¼å« Hugging Face API")
            reply = await query_huggingface(content)
            if reply:
                print("ğŸ¯ HF å›è¦†ï¼š", reply)
                await message.reply(reply, mention_author=True)

    if random.random() < 0.4:
        try:
            unicode_emojis = ["ğŸ˜", "ğŸ”¥", "ğŸ˜", "ğŸ¤”", "ğŸ˜˜", "ğŸ™„", "ğŸ’‹", "â¤ï¸"]
            emoji = random.choice(unicode_emojis)
            print("âœ¨ åŠ å…¥è¡¨æƒ…ï¼š", emoji)
            await message.add_reaction(emoji)
        except Exception as e:
            print("âš ï¸ åŠ è¡¨æƒ…å‡ºéŒ¯ï¼š", e)


# â”€â”€â”€ Flask å¥åº·æª¢æŸ¥ç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app = Flask(__name__)

@app.route("/")
def home():
    return "Bot is alive."

def run_web():
    app.run(host="0.0.0.0", port=8080)

Thread(target=run_web).start()

# â”€â”€â”€ å•Ÿå‹• Discord Bot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
bot.run(discord_token)
